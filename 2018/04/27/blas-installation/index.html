<!doctype html>
<html lang="zh-cn">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4"
    crossorigin="anonymous">

  <link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">


  <style>
    .m-margin {
      margin-top: 2%;
    }

    p {
      font-size: 1.1em;
      line-height: 1.6;
    }

    h2 {
      font-size: 2em;
    }

    body {
      font-family: "Microsoft YaHei", "lucida grande", "lucida sans unicode", lucida, helvetica, "Hiragino Sans GB", "WenQuanYi Micro Hei", sans-serif;
    }
  </style>
  <title>Notes</title>
</head>

<body>
  <!-- As a link -->
  <nav class="navbar navbar-light bg-light">
    <a class="navbar-brand" href="/">Notes</a>
  </nav>
  <div class="container m-margin">
    <h3>
    BLAS Installation
</h3>

<hr style="height:1.2px;color:#C0C0C0;background-color:#C0C0C0; rounded" />


<p><code>BLAS</code>(Basic Linear Algebra Subprograms) has many implementations, mainly <code>ATLAS</code>, <code>GotoBLAS2</code>, <code>OpenBLAS</code>, <code>MKL</code>, <code>Eigen3</code>. This note is about how I <strong>build &amp; install &amp; link</strong> them.</p>
<h3>ATLAS</h3>
<hr>
<p><strong>Info</strong></p>
<ul>
<li>Page: <a href="http://math-atlas.sourceforge.net/" target="_blank" rel="noopener">http://math-atlas.sourceforge.net/</a></li>
<li>Version: 3.10.3 (2016-07-28)</li>
<li>Source Code: <a href="https://sourceforge.net/projects/math-atlas/files/" target="_blank" rel="noopener">https://sourceforge.net/projects/math-atlas/files/</a></li>
<li>Installation Doc: ./INSTALL.txt</li>
</ul>
<p><strong>Build Before</strong></p>
<p>Make sure CPU THROTTLING is turned off. See INSTALL.txt</p>
<p>The following code is how ATLAS checks whether CPU THROTTLING is turned off</p>
<pre><code>// ./CONFIG/src/backend/archinfo_linux.c Line 530-572
/*
 * If cpufreq directory doesn't exist, guess no throttling.  If
 * cpufreq exists, and cur Mhz &lt; max, throttling is enabled,
 * throttling also enabled if governer is not &quot;performance&quot;, and min freq
 * is less than max
 */
</code></pre>
<p>So in BIOS, I set fixed 3.2 Mhz for all CPUs.</p>
<p><strong>Build</strong></p>
<pre><code class="language-bash">$ mkdir my_build_dir ; cd my_build_dir
$ /path/to/ATLAS/configure [flags]
$ make              ! tune and compile library
$ make check        ! perform sanity tests
$ make ptcheck      ! checks of threaded code for multiprocessor systems
$ make time         ! provide performance summary as % of clock rate
</code></pre>
<p><strong>Install</strong></p>
<pre><code class="language-bash">$ make install --prefix=/path/to/install
</code></pre>
<p>or</p>
<pre><code class="language-bash">$ make install DESTDIR=/path/to/install
</code></pre>
<p><strong>How to use?</strong></p>
<p>Assume ATLAS is installed in &lt;ATLAS_ROOT&gt;</p>
<pre><code class="language-bash">$ gcc test_blas.c -I&lt;ATLAS_ROOT&gt;/include -L&lt;ATLAS_ROOT&gt;/lib -lcblas -latlas -o test_blas.out
</code></pre>
<h3>GotoBLAS2</h3>
<hr>
<p><strong>Info</strong></p>
<ul>
<li>Page: <a href="https://www.tacc.utexas.edu/research-development/tacc-software/gotoblas2" target="_blank" rel="noopener">https://www.tacc.utexas.edu/research-development/tacc-software/gotoblas2</a></li>
<li>Version: 1.13</li>
<li>Source Code: <a href="https://www.tacc.utexas.edu/documents/1084364/1087496/GotoBLAS2-1.13.tar.gz" target="_blank" rel="noopener">https://www.tacc.utexas.edu/documents/1084364/1087496/GotoBLAS2-1.13.tar.gz</a></li>
<li>Installation Doc:</li>
</ul>
<p><strong>Bug Fix:</strong></p>
<ol>
<li><code>./driver/others/dynamic.c Line 183-187</code> should be the following:</li>
</ol>
<pre><code class="language-c">#ifdef ARCH_X86
	if (gotoblas == NULL) gotoblas = &amp;gotoblas_KATMAI;
#else
	if (gotoblas == NULL) gotoblas = &amp;gotoblas_PRESCOTT;
#endif
</code></pre>
<ol start="2">
<li><code>./f_check Line 266</code> should be the following:</li>
</ol>
<pre><code class="language-perl">($flags =~ /^\-l\w+/) 
</code></pre>
<p><strong>Build</strong></p>
<pre><code class="language-bash">$ make
</code></pre>
<p>If <code>make</code> fails, try <code>make DYNAMIC_ARCH=1</code></p>
<p><strong>Install</strong></p>
<p>Just copy all files into destination path.</p>
<p><strong>How to use?</strong></p>
<p>Assume GotoBLAS2 is installed in &lt;GotoBLAS2_ROOT&gt;</p>
<pre><code class="language-bash">$ gcc ./test_blas.c -o ./test_blas.out -DEXPRECISION -m128bit-long-double -Wall -m64 -DF_INTERFACE_GFORT -fPIC  -DDYNAMIC_ARCH -DMAX_CPU_NUMBER=4  -w  -I&lt;GotoBLAS2_ROOT&gt; -L&lt;GotoBLAS2_ROOT&gt; -lgoto2 -lm -lgfortran -lquadmath -lc
</code></pre>
<h3>OpenBLAS</h3>
<hr>
<blockquote>
<p>OpenBLAS is an optimized BLAS library based on GotoBLAS2 1.13 BSD version.</p>
</blockquote>
<p><strong>Info</strong></p>
<ul>
<li>Page: <a href="https://www.openblas.net/" target="_blank" rel="noopener">https://www.openblas.net/</a></li>
<li>Github: <a href="https://github.com/xianyi/OpenBLAS" target="_blank" rel="noopener">https://github.com/xianyi/OpenBLAS</a></li>
</ul>
<p><strong>Build &amp; Install</strong></p>
<p><a href="https://github.com/xianyi/OpenBLAS/wiki/Installation-Guide" target="_blank" rel="noopener">https://github.com/xianyi/OpenBLAS/wiki/Installation-Guide</a></p>
<pre><code class="language-bash">$ make
$ make install --prefix=/path/to/install
</code></pre>
<p><strong>How to use?</strong>
Assume OpenBLAS is installed in &lt;OPEN_ROOT&gt;</p>
<pre><code class="language-bash">gcc ./test_blas.c -o ./test_blas.out -I&lt;OPEN_ROOT&gt; -L&lt;OPEN_ROOT&gt; -lopenblas
</code></pre>
<h3>MKL</h3>
<hr>
<blockquote>
<p>Intel速 Math Kernel Library (Intel速 MKL) optimizes code with minimal effort for future generations of Intel速 processors. It is compatible with your choice of compilers, languages, operating systems, and linking and threading models.</p>
</blockquote>
<p>MKL has overall documents, so everything will be easy.</p>
<p><strong>Info</strong></p>
<ul>
<li>Page: <a href="https://software.intel.com/en-us/mkl" target="_blank" rel="noopener">https://software.intel.com/en-us/mkl</a></li>
<li>Doc: <a href="https://software.intel.com/en-us/mkl/documentation" target="_blank" rel="noopener">https://software.intel.com/en-us/mkl/documentation</a></li>
</ul>
<p><strong>Build &amp; Install</strong></p>
<p>After download, it's compiled, so don't need build and install step.</p>
<p><strong>How to use?</strong></p>
<p>You can set environment variables, see <a href="https://software.intel.com/en-us/mkl-linux-developer-guide-linking-on-intel-64-architecture-systems" target="_blank" rel="noopener">here</a>: <em>Getting Started</em>.</p>
<p>Also you can link directly, like <a href="https://software.intel.com/en-us/mkl-linux-developer-guide-linking-on-intel-64-architecture-systems" target="_blank" rel="noopener">this</a>: <em>Linking Your Application with the Intel速 Math Kernel Library</em>.</p>
<h3>Eigen3</h3>
<hr>
<blockquote>
<p>Eigen is a C++ template library for linear algebra: matrices, vectors, numerical solvers, and related algorithms.</p>
</blockquote>
<p><strong>Info</strong></p>
<ul>
<li>Page: <a href="http://eigen.tuxfamily.org" target="_blank" rel="noopener">http://eigen.tuxfamily.org</a></li>
<li>Github: <a href="https://github.com/eigenteam/eigen-git-mirror" target="_blank" rel="noopener">https://github.com/eigenteam/eigen-git-mirror</a></li>
</ul>
<p><strong>Build &amp; Install</strong></p>
<pre><code class="language-bash">$ mkdir build &amp;&amp; cd build
$ cmake .. --DCMAKE_INSTALL_PREFIX=/path/to/install
$ make install
</code></pre>
<p><strong>How to use?</strong>
Assume Eigen3 is installed in &lt;EIGEN3_ROOT&gt;</p>
<pre><code class="language-bash">$ gcc -I&lt;EIGEN3_ROOT&gt; ./test_eigen.cpp -o ./test_eigen.out
</code></pre>
<h3>Appendix</h3>
<hr>
<pre><code class="language-c">// test_blas.c

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;time.h&gt;
#include &lt;sys/time.h&gt;

#ifndef USING_MKL
    #include &quot;cblas.h&quot;
#else
    #include &quot;mkl_cblas.h&quot;
#endif

#define MAX (int)(1e5)
typedef double T;   //S, D, C, Z

T *gen_matrix(int m,  int n, float sparsity)
{
    int i;
    T *mtx = (T *)malloc(sizeof(T) * m * n);
    for(i = 0; i &lt; m*n; i++)
    {
        if(rand() &lt; sparsity * RAND_MAX)
            mtx[i] = 0;
        else
            mtx[i] = rand() % MAX;
    }
    return mtx;
}

int main()
{

    double alhpa = 2.0, beta = 2.0;
    int m = 500, n = 500, k = 500;
    T *A = gen_matrix(m, k, 0);
    T *B = gen_matrix(k, n, 0);
    T *C = gen_matrix(m, n, 0);
    
    print_matrix(A, m, k);
    print_matrix(B, k, n);
    print_matrix(C, m, n);
    
    struct timeval start, end;
    gettimeofday(&amp;start, 0);
    
    cblas_dgemm(CblasRowMajor, CblasNoTrans, CblasNoTrans, 
        m, n, k, alhpa, A, k, B, n, beta, C, n);
        
    gettimeofday(&amp;end, 0);
      
    printf(
            &quot;\nRoutine: C &lt;- alpha*op(A)op(b) + beta*C\n&quot;
            &quot;  M = %d, K = %d, N = %d\n&quot;
            &quot;  Wall time is %ld us\n&quot;, 
            m, k, n, (end.tv_sec-start.tv_sec)*1000000 + (end.tv_usec - start.tv_usec));
    free(A);
    free(B);
    free(C);
    return 0;
}

</code></pre>

  </div>

  </div>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>

  <script>

    $(document).ready(function () {
      $("img").addClass("img-fluid");
    });

    hljs.initHighlightingOnLoad();

  </script>

</body>

</html>